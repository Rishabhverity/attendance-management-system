{% extends 'base.html' %}
{% load static %}

{% block title %}Change Password - HR Leave Management{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-lg-6 mx-auto">
            <!-- Page Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2><i class="bi bi-key"></i> Change Password</h2>
                    <p class="text-muted">Update your account password</p>
                </div>
                <a href="{% url 'frontend:profile' %}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Back to Profile
                </a>
            </div>

            <!-- Change Password Card -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-shield-lock"></i> Password Security</h5>
                </div>
                <div class="card-body">
                    <!-- Display messages -->
                    <div id="password-messages">
                        {% if messages %}
                            {% for message in messages %}
                            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                            {% endfor %}
                        {% endif %}
                    </div>

                    <form method="post"
                          id="change-password-form"
                          hx-post="{% url 'frontend:change_password' %}"
                          hx-target="#password-messages"
                          hx-swap="innerHTML">
                        {% csrf_token %}

                        <!-- Current Password -->
                        <div class="mb-3">
                            <label for="old_password" class="form-label">
                                Current Password <span class="text-danger">*</span>
                            </label>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="bi bi-lock"></i>
                                </span>
                                <input type="password"
                                       class="form-control"
                                       id="old_password"
                                       name="old_password"
                                       required
                                       placeholder="Enter your current password">
                                <button class="btn btn-outline-secondary"
                                        type="button"
                                        onclick="togglePassword('old_password')">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </div>
                        </div>

                        <!-- New Password -->
                        <div class="mb-3">
                            <label for="new_password" class="form-label">
                                New Password <span class="text-danger">*</span>
                            </label>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="bi bi-key"></i>
                                </span>
                                <input type="password"
                                       class="form-control"
                                       id="new_password"
                                       name="new_password"
                                       required
                                       minlength="8"
                                       placeholder="Enter new password (min. 8 characters)">
                                <button class="btn btn-outline-secondary"
                                        type="button"
                                        onclick="togglePassword('new_password')">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </div>
                            <div class="form-text">
                                Password must be at least 8 characters long
                            </div>
                        </div>

                        <!-- Confirm New Password -->
                        <div class="mb-4">
                            <label for="confirm_password" class="form-label">
                                Confirm New Password <span class="text-danger">*</span>
                            </label>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="bi bi-check2-square"></i>
                                </span>
                                <input type="password"
                                       class="form-control"
                                       id="confirm_password"
                                       name="confirm_password"
                                       required
                                       minlength="8"
                                       placeholder="Re-enter new password">
                                <button class="btn btn-outline-secondary"
                                        type="button"
                                        onclick="togglePassword('confirm_password')">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </div>
                            <div class="form-text" id="password-match-feedback"></div>
                        </div>

                        <!-- Password Strength Indicator -->
                        <div class="mb-4">
                            <label class="form-label">Password Strength</label>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar"
                                     id="password-strength-bar"
                                     role="progressbar"
                                     style="width: 0%"></div>
                            </div>
                            <small class="text-muted" id="password-strength-text">Enter a password to check strength</small>
                        </div>

                        <!-- Submit Buttons -->
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary" id="submit-btn">
                                <i class="bi bi-shield-check"></i> Change Password
                            </button>
                            <a href="{% url 'frontend:profile' %}" class="btn btn-outline-secondary">
                                <i class="bi bi-x-circle"></i> Cancel
                            </a>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Security Tips Card -->
            <div class="card mt-4">
                <div class="card-header">
                    <h6 class="mb-0"><i class="bi bi-shield-exclamation"></i> Password Security Tips</h6>
                </div>
                <div class="card-body">
                    <ul class="mb-0 small">
                        <li>Use a mix of uppercase and lowercase letters</li>
                        <li>Include numbers and special characters (!@#$%^&*)</li>
                        <li>Avoid using personal information (name, birthdate, etc.)</li>
                        <li>Don't reuse passwords from other accounts</li>
                        <li>Change your password regularly (every 3-6 months)</li>
                        <li>Never share your password with anyone</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Toggle password visibility
    function togglePassword(fieldId) {
        const field = document.getElementById(fieldId);
        const button = field.nextElementSibling;
        const icon = button.querySelector('i');

        if (field.type === 'password') {
            field.type = 'text';
            icon.classList.remove('bi-eye');
            icon.classList.add('bi-eye-slash');
        } else {
            field.type = 'password';
            icon.classList.remove('bi-eye-slash');
            icon.classList.add('bi-eye');
        }
    }

    // Password strength checker
    document.getElementById('new_password').addEventListener('input', function() {
        const password = this.value;
        const strengthBar = document.getElementById('password-strength-bar');
        const strengthText = document.getElementById('password-strength-text');

        let strength = 0;
        let strengthLabel = '';
        let strengthClass = '';

        if (password.length >= 8) strength += 25;
        if (password.match(/[a-z]/) && password.match(/[A-Z]/)) strength += 25;
        if (password.match(/\d/)) strength += 25;
        if (password.match(/[^a-zA-Z\d]/)) strength += 25;

        if (strength === 0) {
            strengthLabel = 'Enter a password to check strength';
            strengthClass = '';
        } else if (strength <= 25) {
            strengthLabel = 'Weak';
            strengthClass = 'bg-danger';
        } else if (strength <= 50) {
            strengthLabel = 'Fair';
            strengthClass = 'bg-warning';
        } else if (strength <= 75) {
            strengthLabel = 'Good';
            strengthClass = 'bg-info';
        } else {
            strengthLabel = 'Strong';
            strengthClass = 'bg-success';
        }

        strengthBar.style.width = strength + '%';
        strengthBar.className = 'progress-bar ' + strengthClass;
        strengthText.textContent = strengthLabel;
    });

    // Password match validation
    document.getElementById('confirm_password').addEventListener('input', function() {
        const newPassword = document.getElementById('new_password').value;
        const confirmPassword = this.value;
        const feedback = document.getElementById('password-match-feedback');
        const submitBtn = document.getElementById('submit-btn');

        if (confirmPassword.length === 0) {
            feedback.textContent = '';
            feedback.className = 'form-text';
            submitBtn.disabled = false;
        } else if (newPassword === confirmPassword) {
            feedback.textContent = 'Passwords match!';
            feedback.className = 'form-text text-success';
            submitBtn.disabled = false;
        } else {
            feedback.textContent = 'Passwords do not match';
            feedback.className = 'form-text text-danger';
            submitBtn.disabled = true;
        }
    });

    // Clear form and redirect on success
    document.addEventListener('htmx:afterRequest', function(evt) {
        if (evt.detail.successful && evt.detail.xhr.responseText.includes('alert-success')) {
            // Clear form fields
            document.getElementById('change-password-form').reset();

            // Reset password strength
            document.getElementById('password-strength-bar').style.width = '0%';
            document.getElementById('password-strength-bar').className = 'progress-bar';
            document.getElementById('password-strength-text').textContent = 'Enter a password to check strength';

            // Redirect to profile after 2 seconds
            setTimeout(function() {
                window.location.href = '{% url "frontend:profile" %}';
            }, 2000);
        }
    });
</script>
{% endblock %}
